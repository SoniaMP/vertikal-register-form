generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model FederationType {
  id          String       @id @default(cuid())
  name        String
  description String
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  subtypes         FederationSubtype[]
  supplements      Supplement[]
  registrations    Registration[]
  categories       Category[]
  supplementGroups SupplementGroup[]
}

model FederationSubtype {
  id               String   @id @default(cuid())
  name             String
  description      String
  active           Boolean  @default(true)
  federationTypeId String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  federationType FederationType  @relation(fields: [federationTypeId], references: [id])
  registrations  Registration[]
  categoryPrices CategoryPrice[]
}

model Supplement {
  id                String          @id @default(cuid())
  name              String
  description       String
  price             Int?            // Price in cents (null if belongs to a group)
  active            Boolean         @default(true)
  federationTypeId  String
  supplementGroupId String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  federationType          FederationType           @relation(fields: [federationTypeId], references: [id])
  supplementGroup         SupplementGroup?         @relation(fields: [supplementGroupId], references: [id])
  registrationSupplements RegistrationSupplement[]
}

model Category {
  id               String   @id @default(cuid())
  name             String
  description      String
  active           Boolean  @default(true)
  federationTypeId String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  federationType FederationType  @relation(fields: [federationTypeId], references: [id])
  prices         CategoryPrice[]
  registrations  Registration[]
}

model CategoryPrice {
  id         String @id @default(cuid())
  categoryId String
  subtypeId  String
  price      Int    // Price in cents

  category Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  subtype  FederationSubtype @relation(fields: [subtypeId], references: [id], onDelete: Cascade)

  @@unique([categoryId, subtypeId])
}

model SupplementGroup {
  id               String   @id @default(cuid())
  name             String
  price            Int      // Price in cents (charged once for any combo)
  federationTypeId String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  federationType FederationType @relation(fields: [federationTypeId], references: [id])
  supplements    Supplement[]
}

model Registration {
  id                    String   @id @default(cuid())
  firstName             String
  lastName              String
  email                 String
  phone                 String
  dni                   String
  dateOfBirth           String
  address               String
  city                  String
  postalCode            String
  province              String
  federationTypeId      String
  federationSubtypeId   String
  categoryId            String
  totalAmount           Int      // Total in cents
  paymentStatus         String   @default("PENDING") // PENDING | COMPLETED | FAILED | REFUNDED
  active                Boolean  @default(true)
  isFederated           Boolean  @default(false)
  stripeSessionId       String?
  stripePaymentId       String?
  confirmationSent      Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  federationType    FederationType           @relation(fields: [federationTypeId], references: [id])
  federationSubtype FederationSubtype        @relation(fields: [federationSubtypeId], references: [id])
  category          Category                 @relation(fields: [categoryId], references: [id])
  supplements       RegistrationSupplement[]
}

model RegistrationSupplement {
  registrationId String
  supplementId   String
  priceAtTime    Int // Snapshot of the price at registration time

  registration Registration @relation(fields: [registrationId], references: [id])
  supplement   Supplement   @relation(fields: [supplementId], references: [id])

  @@id([registrationId, supplementId])
}

model AdminUser {
  id           String @id @default(cuid())
  email        String @unique
  passwordHash String
  name         String
}

model AppSetting {
  key   String @id
  value String
}
