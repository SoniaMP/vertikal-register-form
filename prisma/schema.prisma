generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model Season {
  id        String   @id @default(cuid())
  name      String   // e.g. "2025-2026"
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  offerings             LicenseOffering[]
  supplementPrices      SupplementPrice[]
  supplementGroupPrices SupplementGroupPrice[]
  memberships           Membership[]
}

model LicenseType {
  id          String   @id @default(cuid())
  name        String
  description String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subtypes    LicenseSubtype[]
  offerings   LicenseOffering[]
  memberships Membership[]
}

model LicenseSubtype {
  id            String   @id @default(cuid())
  name          String
  description   String
  active        Boolean  @default(true)
  licenseTypeId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  licenseType LicenseType @relation(fields: [licenseTypeId], references: [id])
  offerings   LicenseOffering[]
  memberships Membership[]
}

model Category {
  id          String   @id @default(cuid())
  name        String
  description String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  offerings   LicenseOffering[]
  memberships Membership[]
}

model LicenseOffering {
  id         String @id @default(cuid())
  seasonId   String
  typeId     String
  subtypeId  String
  categoryId String
  price      Int    // Price in cents

  season   Season         @relation(fields: [seasonId], references: [id])
  type     LicenseType    @relation(fields: [typeId], references: [id])
  subtype  LicenseSubtype @relation(fields: [subtypeId], references: [id])
  category Category        @relation(fields: [categoryId], references: [id])

  memberships Membership[]

  @@unique([seasonId, typeId, subtypeId, categoryId])
}

model SupplementGroup {
  id        String   @id @default(cuid())
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplements Supplement[]
  groupPrices SupplementGroupPrice[]
}

model Supplement {
  id                String   @id @default(cuid())
  name              String
  description       String
  active            Boolean  @default(true)
  supplementGroupId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  supplementGroup       SupplementGroup?     @relation(fields: [supplementGroupId], references: [id])
  prices                SupplementPrice[]
  membershipSupplements MembershipSupplement[]
}

model SupplementPrice {
  id           String @id @default(cuid())
  seasonId     String
  supplementId String
  price        Int    // Price in cents

  season     Season       @relation(fields: [seasonId], references: [id])
  supplement Supplement @relation(fields: [supplementId], references: [id])

  @@unique([seasonId, supplementId])
}

model SupplementGroupPrice {
  id      String @id @default(cuid())
  seasonId String
  groupId  String
  price    Int    // Price in cents (charged once for any combo in the group)

  season Season           @relation(fields: [seasonId], references: [id])
  group  SupplementGroup @relation(fields: [groupId], references: [id])

  @@unique([seasonId, groupId])
}

// ──────────────────────────────────────────────
// Member: person identity (DNI unique)
// ──────────────────────────────────────────────
model Member {
  id          String   @id @default(cuid())
  dni         String   @unique
  firstName   String
  lastName    String
  email       String
  phone       String
  dateOfBirth String
  address     String
  city        String
  postalCode  String
  province    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships Membership[]

  @@index([dni])
  @@index([email])
  @@index([lastName, firstName])
}

// ──────────────────────────────────────────────
// Membership: annual instance per member
// Status: PENDING_PAYMENT | ACTIVE | EXPIRED | CANCELLED
// PaymentStatus: PENDING | COMPLETED | FAILED | REFUNDED
// ──────────────────────────────────────────────
model Membership {
  id                   String    @id @default(cuid())
  memberId             String
  seasonId             String
  status               String    @default("PENDING_PAYMENT")
  typeId               String?
  subtypeId            String?
  categoryId           String
  offeringId           String?
  licensePriceSnapshot Int       @default(0)
  licenseLabelSnapshot String    @default("")
  isFederated          Boolean   @default(false)
  totalAmount          Int
  paymentStatus        String    @default("PENDING")
  stripeSessionId      String?
  stripePaymentId      String?
  confirmationSent     Boolean   @default(false)
  consentedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  member            Member                 @relation(fields: [memberId], references: [id], onDelete: Cascade)
  season            Season                 @relation(fields: [seasonId], references: [id])
  type              LicenseType?           @relation(fields: [typeId], references: [id])
  subtype           LicenseSubtype?        @relation(fields: [subtypeId], references: [id])
  offering          LicenseOffering?       @relation(fields: [offeringId], references: [id])
  category          Category               @relation(fields: [categoryId], references: [id])
  supplements       MembershipSupplement[]

  @@unique([memberId, seasonId])
  @@index([seasonId, status])
  @@index([seasonId, paymentStatus])
  @@index([stripeSessionId])
}

// ──────────────────────────────────────────────
// MembershipSupplement: junction with price snapshot
// ──────────────────────────────────────────────
model MembershipSupplement {
  membershipId String
  supplementId String
  priceAtTime  Int

  membership Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  supplement Supplement @relation(fields: [supplementId], references: [id])

  @@id([membershipId, supplementId])
}

// ──────────────────────────────────────────────
// Auth: User / Role / UserRole
// ──────────────────────────────────────────────
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  roles UserRole[]
}

model Role {
  id   String @id @default(cuid())
  name String @unique // e.g. "ADMIN", "MANAGER"

  users UserRole[]
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model AppSetting {
  key   String @id
  value String
}

// ──────────────────────────────────────────────
// Courses: types, catalog, pricing, registrations
// ──────────────────────────────────────────────
model CourseType {
  id     String  @id @default(cuid())
  name   String
  active Boolean @default(true)

  courses CourseCatalog[]
}

model CourseCatalog {
  id           String    @id @default(cuid())
  title        String
  slug         String    @unique
  image        String?
  courseDate   DateTime
  courseTypeId String
  address      String
  lat          Float?
  lng          Float?
  placeId      String?
  description  String
  isActive     Boolean   @default(true)
  maxCapacity  Int
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  courseType     CourseType          @relation(fields: [courseTypeId], references: [id])
  prices        CoursePrice[]
  registrations CourseRegistration[]

  @@index([courseDate])
  @@index([isActive, courseDate])
}

model CoursePrice {
  id              String    @id @default(cuid())
  courseCatalogId String
  name            String
  amountCents     Int
  isActive        Boolean   @default(true)
  saleStart       DateTime?
  saleEnd         DateTime?

  courseCatalog CourseCatalog        @relation(fields: [courseCatalogId], references: [id], onDelete: Cascade)
  registrations CourseRegistration[]
}

model CourseRegistration {
  id                    String   @id @default(cuid())
  courseCatalogId       String
  coursePriceId         String
  firstName             String
  lastName              String
  email                 String
  phone                 String?
  dni                   String?
  dateOfBirth           String?
  address               String?
  city                  String?
  postalCode            String?
  province              String?
  licenseFileUrl        String?
  paymentStatus         String   @default("PENDING")
  stripeSessionId       String?
  stripePaymentIntentId String?
  confirmationSent      Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  courseCatalog CourseCatalog @relation(fields: [courseCatalogId], references: [id])
  coursePrice   CoursePrice   @relation(fields: [coursePriceId], references: [id])

  @@index([courseCatalogId, paymentStatus])
  @@index([stripeSessionId])
  @@map("courses")
}
